SELECT DISTINCT actv_cd,
	clasf_cd
INTO #TEMP_CPT
FROM SMSMIR.mir_actv_proc_seg_xref
WHERE proc_pyr_ind = 'H'
	AND clasf_cd IN (
		'76376', '76377', '77078', '77080', '77081', '77085', '70450', '70460', '70470', '70480', '70481', '70482', '70486', '70487', '70488', '70490', '70491', '70492', '70496', '70498', '71250', '71260', '71270', '71275', '72125', '72126', '72127', '72128', '72129', '72130', '72131', '72132', '72133', '72191', '72192', '72193', '72194', '73200', '73201', '73202', '73206', '73700', '73701', '73702', '73706', '74150', '74160', '74170', '74174', '74175', '74176', '74177', '74178', '74261', '74262', '75571', '75572', '75573', '75574', '75635', '76380', '77011', '77012', '77013', '70010', '70015', '70030', '70100', '70110', '70120', '70130', '70134', '70140', '70150', '70160', '70170', '70190', '70200', '70210', '70220', '70240', '70250', '70260', '70300', '70310', '70320', '70328', '70330', '70350', '70355', '70360', '70370', '70371', '70373', '70380', '71010', '71015', '71020', '71021', '71022', '71023', '71030', '71034', '71035', '71100', '71101', '71110', '71111', '71120', '71130', '72010', '72020', '72040', '72050', '72052', '72069', '72070', '72072', '72074', '72080', '72090', '72100', '72110', '72114'
		, '72120', '72170', '72190', '72200', '72202', '72220', '72275', '72285', '73000', '73010', '73020', '73030', '73050', '73060', '73070', '73080', '73090', '73092', '73100', '73110', '73120', '73130', '73140', '73500', '73510', '73520', '73530', '73540', '73550', '73560', '73562', '73564', '73565', '73590', '73592', '73600', '73610', '73620', '73630', '73650', '73660', '74000', '74010', '74020', '74022', '74190', '74210', '74220', '74249', '74260', '74290', '74305', '74320', '74400', '74410', '74415', '74420', '74775', '76010', '76080', '76098', '76100', '76101', '76102', '76120', '76125', '77071', '77072', '77073', '77074', '77075', '77076', '77077', '74230', '74240', '74241', '74245', '74246', '74247', '74250', '74251', '74270', '74280', '74283', '74740', '76000', '76001', '77001', '77002', '77003', '70332', '70390', '72240', '72255', '72265', '72270', '72295', '73040', '73085', '73115', '73525', '73580', '73615', '74235', '74327', '74328', '74329', '74330', '74340', '74355', '74360', '74363', '74425', '74430', '74440', '74445', '74450', '74455', '74470', '74475', '74480', '74485', '74742', 
		'75600', '75605', '75625', '75630', '75658', '75705', '75710', '75716', '75726', '75731', '75733', '75736', '75741', '75743', '75746', '75756', '75774', '75791', '75801', '75803', '75805', '75807', '75809', '75810', '75820', '75822', '75825', '75827', '75831', '75833', '75840', '75842', '75860', '75870', '75872', '75880', '75885', '75887', '75889', '75891', '75893', '75894', '75896', '75898', '75945', '75946', '75962', '75964', '75966', '75968', '75970', '75978', '75980', '75982', '75984', '75989', '76140', '77053', '77054', '77055', '77056', '77057', 'G0202', 'G0204', 'G0206', '77051', '77052', '70544', '70545', '70546', '70547', '70548', '70549', '71555', '72159', '72198', '73225', '73725', '74185', '70336', '70540', '70542', '70543', '70551', '70552', '70553', '70554', '70555', '71550', '71551', '71552', '72141', '72142', '72146', '72147', '72148', '72149', '72156', '72157', '72158', '72195', '72196', '72197', '73218', '73219', '73220', '73221', '73222', '73223', '73718', '73719', '73720', '73721', '73722', '73723', '74181', '74182', '74183', '75557', '75559', '75561', '75563', '75565', '76390'
		, '77021', '77022', '77058', '77059', '77084', '78414', '78428', '78445', '78451', '78452', '78453', '78454', '78456', '78457', '78458', '78466', '78468', '78469', '78472', '78473', '78481', '78483', '78494', '78496', '78012', '78013', '78014', '78015', '78016', '78018', '78020', '78070', '78071', '78072', '78075', '78102', '78103', '78104', '78110', '78111', '78120', '78121', '78122', '78130', '78135', '78140', '78185', '78190', '78191', '78195', '78201', '78202', '78205', '78206', '78215', '78216', '78226', '78227', '78230', '78231', '78232', '78258', '78261', '78262', '78264', '78267', '78268', '78270', '78271', '78272', '78278', '78282', '78290', '78291', '78300', '78305', '78306', '78315', '78320', '78579', '78580', '78582', '78597', '78598', '78600', '78601', '78605', '78606', '78607', '78610', '78630', '78635', '78645', '78647', '78650', '78660', '78700', '78701', '78707', '78708', '78709', '78710', '78725', '78730', '78740', '78761', '78800', '78801', '78802', '78803', '78804', '78805', '78806', '78807', '78459', '78491', '78492', '78608', '78609', '78811', '78812', '78813', '78814', 
		'78815', '78816', '76506', '76536', '76604', '76641', '76642', '76700', '76705', '76770', '76775', '76776', '76800', '76830', '76831', '76856', '76857', '76870', '76872', '76873', '76881', '76882', '76885', '76886', '76930', '76932', '76936', '76937', '76940', '76941', '76942', '76945', '76946', '76948', '76970', '76975', '76998', '76801', '76802', '76805', '76810', '76811', '76812', '76813', '76814', '76815', '76816', '76817', '76818', '76819', '76820', '76821', '76825', '76826', '76827', '76828', 'A9500', 'A9502', 'A9503', 'A9505', 'A9507', 'A9508', 'A9509', 'A9510', 'A9512', 'A9516', 'A9520', 'A9521', 'A9524', 'A9528', 'A9529', 'A9531', 'A9537', 'A9538', 'A9539', 'A9540', 'A9541', 'A9542', 'A9544', 'A9547', 'A9548', 'A9551', 'A9553', 'A9554', 'A9556', 'A9557', 'A9558', 'A9560', 'A9561', 'A9562', 'A9567', 'A9569', 'A9570', 'A9571', 'A9572', 'A9582'
		);

SELECT A.pt_id,
	A.actv_cd,
	A.seq_no,
	B.clasf_cd
INTO #TEMP_PROC
FROM smsmir.actv AS A
INNER JOIN smsmir.mir_actv_proc_seg_xref AS B ON A.actv_cd = B.actv_cd
	AND B.proc_pyr_ind = 'H'
WHERE A.seq_no <= 30
	AND B.clasf_cd IN (
		SELECT DISTINCT clasf_cd
		FROM #TEMP_CPT
		)
ORDER BY A.seq_no;

SELECT pt_id,
	actv_cd,
	clasf_cd,
	RN_SEQ_NO = ROW_NUMBER() OVER (
		PARTITION BY PT_ID ORDER BY SEQ_NO
		)
INTO #TEMPB
FROM #TEMP_PROC;

--select * from #TEMPB
SELECT PAV.Med_Rec_No,
	PAV.PtNo_Num,
	PAV.Pt_Name,
	CAST(PAV.Adm_Date AS DATE) AS [Adm_Date],
	PAV.tot_chg_amt,
	PAV.Tot_Amt_Due,
	ACT.actv_cd,
	ADV.actv_name,
	XREF.clasf_cd,
	PYRPLAN.tot_pay_amt AS [Ins_Pay_Amt],
	[Pt_Pay_Amt] = (
		SELECT SUM(PTPAY.Tot_Pt_Pymts)
		FROM SMSDSS.c_pt_payments_v AS PTPAY
		WHERE PTPAY.pt_id = PAV.Pt_No
			AND PTPAY.from_file_ind = PAV.from_file_ind
		GROUP BY PTPAY.pt_id
		),
	DXGRP.DX_CD_1,
	DXGRP.DX_CD_2,
	DXGRP.DX_CD_3,
	DXGRP.DX_CD_4,
	DXGRP.DX_CD_5,
	DXGRP.DX_CD_6,
	DXGRP.DX_CD_7,
	DXGRP.DX_CD_8,
	DXGRP.DX_CD_9,
	DXGRP.DX_CD_10,
	DXGRP.DX_CD_11,
	DXGRP.DX_CD_12,
	DXGRP.DX_CD_13,
	DXGRP.DX_CD_14,
	DXGRP.DX_CD_15,
	DXGRP.DX_CD_16,
	DXGRP.DX_CD_17,
	DXGRP.DX_CD_18,
	DXGRP.DX_CD_19,
	DXGRP.DX_CD_20,
	DXGRP.DX_CD_21,
	DXGRP.DX_CD_22,
	DXGRP.DX_CD_23,
	DXGRP.DX_CD_24,
	DXGRP.DX_CD_25,
	DXGRP.DX_CD_26,
	DXGRP.DX_CD_27,
	DXGRP.DX_CD_28,
	DXGRP.DX_CD_29,
	DXGRP.DX_CD_30,
	CPT.PROC_CD_1,
	CPT.PROC_CD_2,
	CPT.PROC_CD_3,
	CPT.PROC_CD_4,
	CPT.PROC_CD_5,
	CPT.PROC_CD_6,
	CPT.PROC_CD_7,
	CPT.PROC_CD_8,
	CPT.PROC_CD_9,
	CPT.PROC_CD_10,
	CPT.PROC_CD_11,
	CPT.PROC_CD_12,
	CPT.PROC_CD_13,
	CPT.PROC_CD_14,
	CPT.PROC_CD_15,
	CPT.PROC_CD_16,
	CPT.PROC_CD_17,
	CPT.PROC_CD_18,
	CPT.PROC_CD_19,
	CPT.PROC_CD_20,
	CPT.PROC_CD_21,
	CPT.PROC_CD_22,
	CPT.PROC_CD_23,
	CPT.PROC_CD_24,
	CPT.PROC_CD_25,
	CPT.PROC_CD_26,
	CPT.PROC_CD_27,
	CPT.PROC_CD_28,
	CPT.PROC_CD_29,
	CPT.PROC_CD_30
FROM SMSDSS.BMH_PLM_PtAcct_V AS PAV
LEFT OUTER JOIN SMSMIR.actv AS ACT ON PAV.PT_NO = ACT.pt_id
	AND PAV.unit_seq_no = ACT.unit_seq_no
	AND PAV.from_file_ind = ACT.from_file_ind
	AND ACT.actv_cd IN (
		SELECT DISTINCT AAA.actv_cd
		FROM #TEMP_CPT AS AAA
		)
LEFT OUTER JOIN SMSDSS.ACTV_CD_DIM_V AS ADV ON ACT.actv_cd = ADV.actv_cd
	AND ACT.orgz_cd = ADV.orgz_cd
LEFT OUTER JOIN SMSMIR.mir_actv_proc_seg_xref AS XREF ON ACT.actv_cd = XREF.actv_cd
	AND XREF.proc_pyr_ind = 'H'
LEFT OUTER JOIN smsmir.pyr_plan AS PYRPLAN ON PAV.PT_NO = PYRPLAN.pt_id
	AND PAV.unit_seq_no = PYRPLAN.unit_seq_no
	AND PAV.from_file_ind = PYRPLAN.from_file_ind
	AND PAV.Pyr1_Co_Plan_Cd = PYRPLAN.pyr_cd
	AND PAV.Regn_Hosp = PYRPLAN.orgz_cd
LEFT OUTER JOIN (
	SELECT PVT.pt_id,
		PVT.unit_seq_no,
		PVT.from_file_ind,
		PVT.[01] AS [DX_CD_1],
		PVT.[02] AS [DX_CD_2],
		PVT.[03] AS [DX_CD_3],
		PVT.[04] AS [DX_CD_4],
		PVT.[05] AS [DX_CD_5],
		PVT.[06] AS [DX_CD_6],
		PVT.[07] AS [DX_CD_7],
		PVT.[08] AS [DX_CD_8],
		PVT.[09] AS [DX_CD_9],
		PVT.[10] AS [DX_CD_10],
		PVT.[11] AS [DX_CD_11],
		PVT.[12] AS [DX_CD_12],
		PVT.[13] AS [DX_CD_13],
		PVT.[14] AS [DX_CD_14],
		PVT.[15] AS [DX_CD_15],
		PVT.[16] AS [DX_CD_16],
		PVT.[17] AS [DX_CD_17],
		PVT.[18] AS [DX_CD_18],
		PVT.[19] AS [DX_CD_19],
		PVT.[20] AS [DX_CD_20],
		PVT.[21] AS [DX_CD_21],
		PVT.[22] AS [DX_CD_22],
		PVT.[23] AS [DX_CD_23],
		PVT.[24] AS [DX_CD_24],
		PVT.[25] AS [DX_CD_25],
		PVT.[26] AS [DX_CD_26],
		PVT.[27] AS [DX_CD_27],
		PVT.[28] AS [DX_CD_28],
		PVT.[29] AS [DX_CD_29],
		PVT.[30] AS [DX_CD_30]
	FROM (
		SELECT A.pt_id,
			A.unit_seq_no,
			A.from_file_ind,
			A.dx_cd,
			A.dx_cd_prio
		FROM smsmir.dx_grp AS A
		WHERE LEFT(dx_cd_type, 2) = 'DF'
			AND dx_cd_prio <= 30
		) AS A
	PIVOT(MAX(A.DX_CD) FOR DX_CD_PRIO IN ("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30")) AS PVT
	) AS DXGRP ON PAV.PT_NO = DXGRP.pt_id
	AND PAV.unit_seq_no = DXGRP.unit_seq_no
	AND PAV.from_file_ind = DXGRP.from_file_ind
LEFT OUTER JOIN (
	SELECT PVT.pt_id,
		PVT.[1] AS [PROC_CD_1],
		PVT.[2] AS [PROC_CD_2],
		PVT.[3] AS [PROC_CD_3],
		PVT.[4] AS [PROC_CD_4],
		PVT.[5] AS [PROC_CD_5],
		PVT.[6] AS [PROC_CD_6],
		PVT.[7] AS [PROC_CD_7],
		PVT.[8] AS [PROC_CD_8],
		PVT.[9] AS [PROC_CD_9],
		PVT.[10] AS [PROC_CD_10],
		PVT.[11] AS [PROC_CD_11],
		PVT.[12] AS [PROC_CD_12],
		PVT.[13] AS [PROC_CD_13],
		PVT.[14] AS [PROC_CD_14],
		PVT.[15] AS [PROC_CD_15],
		PVT.[16] AS [PROC_CD_16],
		PVT.[17] AS [PROC_CD_17],
		PVT.[18] AS [PROC_CD_18],
		PVT.[19] AS [PROC_CD_19],
		PVT.[20] AS [PROC_CD_20],
		PVT.[21] AS [PROC_CD_21],
		PVT.[22] AS [PROC_CD_22],
		PVT.[23] AS [PROC_CD_23],
		PVT.[24] AS [PROC_CD_24],
		PVT.[25] AS [PROC_CD_25],
		PVT.[26] AS [PROC_CD_26],
		PVT.[27] AS [PROC_CD_27],
		PVT.[28] AS [PROC_CD_28],
		PVT.[29] AS [PROC_CD_29],
		PVT.[30] AS [PROC_CD_30]
	FROM (
		SELECT pt_id,
			clasf_cd,
			CAST(rn_seq_no AS INT) AS RN_SEQ_NO
		FROM #TEMPB
		) AS A
	PIVOT(MAX(clasf_CD) FOR RN_seq_no IN ("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30")) AS PVT
	) AS CPT ON PAV.PT_NO = CPT.pt_id
WHERE PAV.PT_NO IN (
		SELECT DISTINCT ZZZ.PT_ID
		FROM SMSMIR.ACTV AS ZZZ
		WHERE ZZZ.actv_cd IN (
				SELECT DISTINCT XXX.actv_cd
				FROM #TEMP_CPT AS XXX
				)
		)
	AND PAV.Pyr1_Co_Plan_Cd IN ('K30')
	AND PAV.tot_chg_amt > 0
	AND PAV.Tot_Amt_Due != 0
	AND LEFT(PAV.PtNo_Num, 1) != '2'
	AND LEFT(PAV.PtNo_Num, 4) != '1999'
	AND PAV.Adm_Date >= '2016-01-01'
	AND PAV.Adm_Date < '2020-04-01'

DROP TABLE #TEMP_CPT, #TEMP_PROC, #TEMPB