-- AAA_Repair
SELECT SPROC.pt_id
, CAST(SPROC.proc_eff_date AS date) AS [proc_eff_date]
, DATEPART(YEAR, SPROC.proc_eff_date) AS [Svc_Yr]
, DATEPART(MONTH, SPROC.proc_eff_date) AS [Svc_Mo]
, SPROC.proc_cd
, SPROC_DESC.clasf_desc
, SPROC.proc_cd_prio
, SPROC.resp_pty_cd
, UPPER(PDV.pract_rpt_name) AS [Provider_Name]
, Surgery.Surg_Type
, [RN] = ROW_NUMBER() OVER(PARTITION BY SPROC.PT_ID ORDER BY SPROC.PT_ID, SPROC.PROC_CD_PRIO)

INTO #TEMPA

FROM smsmir.sproc AS SPROC
LEFT OUTER JOIN smsdss.proc_dim_v AS SPROC_DESC
ON SPROC.proc_cd = SPROC_DESC.proc_cd
AND SPROC.proc_cd_schm = SPROC_DESC.proc_cd_schm
LEFT OUTER JOIN smsdss.pract_dim_v AS PDV
ON SPROC.resp_pty_cd = PDV.src_pract_no
AND SPROC.orgz_cd = PDV.orgz_cd

CROSS APPLY (
	SELECT
		CASE
			WHEN SPROC.proc_cd IN (
				'04R00JZ','04Q00ZZ','04QC0ZZ','04QD0ZZ','0410090',
				'0410096','0410097','0410098','0410099','041009B ',
				'041009C','041009D','041009F','041009G','041009H',
				'041009J','041009K','041009Q','041009R','04100A0',
				'04100A6','04100A7','04100A8','04100A9','04100AB',
				'04100AC','04100AD','04100AF','04100AG','04100AH',
				'04100AJ','04100AK','04100AQ','04100AR','04100J0',
				'04100J6','04100J7','04100J8','04100J9','04100JB',
				'04100JC','04100JD','04100JF','04100JG','04100JH',
				'04100JJ','04100JK','04100JQ','04100JR','04100K0',
				'04100K6','04100K7','04100K8','04100K9','04100KB',
				'04100KC','04100KD','04100KF','04100KG','04100KH',
				'04100KJ','04100KK','04100KQ','04100KR','04100Z0',
				'04100Z6','04100Z7','04100Z8','04100Z9','04100ZB',
				'04100ZC','04100ZD','04100ZF','04100ZG','04100ZH',
				'04100ZJ','04100ZK','04100ZQ','04100ZR','04500ZZ',
				'04B00ZZ','04H00DZ','04L00DZ','04L00ZZ','04R007Z',
				'04R00KZ','04U00JZ','04U00KZ','04V00D6','04V00Z6'
			)
		THEN 'AAA_Repair'
	END AS [Surg_Type]
) [Surgery]

WHERE SPROC.proc_cd IN (
	-- AAA REPAIR
	'04R00JZ','04Q00ZZ','04QC0ZZ','04QD0ZZ','0410090',
	'0410096','0410097','0410098','0410099','041009B',
	'041009C','041009D','041009F','041009G','041009H',
	'041009J','041009K','041009Q','041009R','04100A0',
	'04100A6','04100A7','04100A8','04100A9','04100AB',
	'04100AC','04100AD','04100AF','04100AG','04100AH',
	'04100AJ','04100AK','04100AQ','04100AR','04100J0',
	'04100J6','04100J7','04100J8','04100J9','04100JB',
	'04100JC','04100JD','04100JF','04100JG','04100JH',
	'04100JJ','04100JK','04100JQ','04100JR','04100K0',
	'04100K6','04100K7','04100K8','04100K9','04100KB',
	'04100KC','04100KD','04100KF','04100KG','04100KH',
	'04100KJ','04100KK','04100KQ','04100KR','04100Z0',
	'04100Z6','04100Z7','04100Z8','04100Z9','04100ZB',
	'04100ZC','04100ZD','04100ZF','04100ZG','04100ZH',
	'04100ZJ','04100ZK','04100ZQ','04100ZR','04500ZZ',
	'04B00ZZ','04H00DZ','04L00DZ','04L00ZZ','04R007Z',
	'04R00KZ','04U00JZ','04U00KZ','04V00D6','04V00Z6'
)
AND SPROC.pt_id IN (
	SELECT distinct(pt_id)
	FROM smsmir.dx_grp
	WHERE dx_cd IN (
		'I71.3','I71.4','I71.5','I71.6','I71.8','I71.9'
	)
	AND LEFT(dx_cd_type, 2) = 'DF'
)
AND SPROC.proc_eff_date >= '2016-01-01'
AND SPROC.proc_eff_date < '2018-01-01'

ORDER BY Surgery.Surg_Type
, PDV.pract_rpt_name
, SPROC.pt_id
, SPROC.proc_cd_prio

GO
;

SELECT A.pt_id
, A.proc_eff_date
, A.Svc_Yr
, A.Svc_Mo
, A.proc_cd
, A.clasf_desc
, A.proc_cd_prio
, A.resp_pty_cd
, A.Provider_Name
, A.Surg_Type

FROM #TEMPA AS A

WHERE A.RN = 1

GO
;

DROP TABLE #TEMPA
GO
;
