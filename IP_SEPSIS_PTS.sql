DECLARE @SD DATETIME
DECLARE @ED DATETIME
SET @SD = '2013-04-01';
SET @ED = '2013-06-30';

-- COLUMN SELECTION
SELECT 
DISTINCT PV.PtNo_Num AS 'VISIT ID'
, PV.Med_Rec_No AS 'MRN'
, PV.vst_start_dtime AS 'ADMIT'
, PV.vst_end_dtime AS 'DISC'
, PV.Days_Stay AS 'LOS'
, PV.dsch_disp AS 'DISPO'
, CASE
    WHEN PV.dsch_disp IN (
    'C1A','C1N','C1Z','C2A','C2N','C2Z','C3A','C3N',
    'C3Z','C4A','C4N','C4Z','C7A','C7N','C7Z','C8A',
    'C8N','C8Z','D1A','D1N','D1Z','D2A','D2N','D2Z',
    'D3A','D3N','D3Z','D4A','D4N','D4Z','D7A','D7N',
    'D7Z','D8A','D8N','D8Z'
    )
    THEN 1
    ELSE 0
  END AS MORTALITY
, PV.pt_type AS 'PT TYPE'
, PV.hosp_svc AS 'HOSP SVC'
, SO.ord_no AS 'ORDER NUMBER'
--, SO.ent_dtime AS 'ORDER ENTRY TIME'
--, DATEDIFF(HOUR,PV.vst_start_dtime,SO.ent_dtime) AS 'ADM TO ENTRY HOURS'
, SO.svc_cd AS 'SVC CD'
, SO.svc_desc AS 'ORD DESC'
, OSM.ord_sts AS 'ORD STS'
, SOS.prcs_dtime AS 'ORD STS TIME'
-- NEGATIVE HRS INDICATES THAT TEST WAS ORDERED PRE-ADMIT SENT OVER BY
-- ED
, DATEDIFF(HOUR,PV.vst_start_dtime,SOS.prcs_dtime) AS 'ADM TO ORD STS IN HRS'

FROM smsdss.BMH_PLM_PtAcct_Clasf_Dx_V PDV
JOIN smsdss.BMH_PLM_PtAcct_V PV
ON PDV.PtNo_Num = PV.PtNo_Num
JOIN smsdss.dx_cd_dim_v DX
ON PV.prin_dx_cd = DX.dx_cd
JOIN smsmir.sr_ord SO
ON PV.PtNo_Num = SO.episode_no
JOIN smsmir.sr_ord_sts_hist SOS
ON SO.ord_no = SOS.ord_no
JOIN smsmir.ord_sts_modf_mstr OSM
ON SOS.hist_sts = OSM.ord_sts_modf_cd

WHERE PDV.ClasfCd IN (
	'785.52', '995.91', '995.92', '995.93', '995.94', '999.39', '999.89'
	)
AND PV.hosp_svc NOT IN (
	'DIA'
	,'DMS'
	,'EME'
	)
AND PV.Adm_Date BETWEEN @SD AND @ED
AND SO.svc_cd IN (
	'00407304',
	'00507301',
	--'00600015', -- <-- EKG
	'00402347',
	'PRE_P12079NR',
	'PRE_P12081NR',
	'P_12056',
	'R_76597',
	'P_12084',
	'R_76502',
	'P_12087',
	'P_2360',
	'R_32591',
	'P_2362',
	'R_32589',
	'P_2363',
	'P_2365',
	'P_2373',
	'P_2374',
	'P_2402',
	'P_26881',
	'R_32590',
	'P_6513',
	'P_6669',
	'R_2298',
	'P_6840',
	'PRE_12056100',
	'PRE_1207675',
	'PRE_12088100',
	'PRE_12089100',
	'PRE_1209675',
	'PRE_P12078',
	'PRE_P12084',
	'PRE_P12092',
	'PRE_P12095',
	'PRE_P43291',
	'PREIV_D5.5NSK42',
	'PREIV_D512NS001',
	'PREIV_D512NS002',
	'PREIV_D512NS003',
	'PREIV_D512NS004',
	'PREIV_D512NS005',
	'PREIV_D512NS006',
	'PREIV_D512NS007',
	'PREIV_D512NSK002',
	'PREIV_D512NSK003',
	'PREIV_D512NSK004',
	'PREIV_D512NSK005',
	'PREIV_D512NSK006',
	'PREIV_D512NSK007',
	'PREIV_D512NSK008',
	'PREIV_D512NSK009',
	'PREIV_D512NSK010',
	'PREIV_D512NSK011',
	'PREIV_D512NSK012',
	'PREIV_D512NSK013',
	'PREIV_D512NSK014',
	'PREIV_D512NSK015',
	'PREIV_D512NSK016',
	'PREIV_D512NSK017',
	'PREIV_D512NSK018',
	'PREIV_D512NSK019',
	'PREIV_D512NSK020',
	'PREIV_D512NSK021',
	'PREIV_D512NSK022',
	'PREIV_D512NSK023',
	'PREIV_D512NSK024',
	'PREIV_D512NSK025',
	'PREIV_D512NSK026',
	'PREIV_D512NSK027',
	'PREIV_D512NSK028',
	'PREIV_D514NS001',
	'PREIV_D514NS002',
	'PREIV_D514NS003',
	'PREIV_D514NS004',
	'PREIV_D514NS005',
	'PREIV_D514NS006',
	'PREIV_D514NS007',
	'PREIV_D5150ML/HR',
	'PREIV_D5K008',
	'PREIV_D5K009',
	'PREIV_D5K010',
	'PREIV_D5K011',
	'PREIV_D5K012',
	'PREIV_D5K013',
	'PREIV_D5K014',
	'PREIV_D5K022',
	'PREIV_D5K023',
	'PREIV_D5K024',
	'PREIV_D5K025',
	'PREIV_D5K026',
	'PREIV_D5K027',
	'PREIV_D5K028',
	'PREIV_D5LR001',
	'PREIV_D5LR002',
	'PREIV_D5LR003',
	'PREIV_D5LR004',
	'PREIV_D5LR005',
	'PREIV_D5LR006',
	'PREIV_D5LR150',
	'PREIV_D5LRK014',
	'PREIV_D5NS0.2%42',
	'PREIV_D5NS001',
	'PREIV_D5NS002',
	'PREIV_D5NS003',
	'PREIV_D5NS004',
	'PREIV_D5NS005',
	'PREIV_D5NS006',
	'PREIV_D5NS007',
	'PREIV_D5NSK008',
	'PREIV_D5NSK009',
	'PREIV_D5NSK010',
	'PREIV_D5NSK011',
	'PREIV_D5NSK012',
	'PREIV_D5NSK013',
	'PREIV_D5NSK014',
	'PREIV_D5W001',
	'PREIV_D5W002',
	'PREIV_D5W003',
	'PREIV_D5W004',
	'PREIV_D5W006',
	'PRE_12082D5W',
	'PRE_12088IV01',
	'PRE_1208502',
	'PRE_1028503',
	'PRE_1028504',
	'PRE_P1351q6',
	'PRE_P12106NR',
	'PRE_P12107NR',
	'P_12105',
	'R_145556',
	'P_12106',
	'P_12107',
	'P_12108',
	'P_12808',
	'R_145555',
	'P_1351',
	'R_11043',
	'P_1602',
	'R_16233',
	'P_17290',
	'R_148220',
	'P_2368',
	'P_2371',
	'P_2372',
	'P_2375',
	'P_2376',
	'P_2390',
	'R_18381',
	'P_2393',
	'R_148221',
	'P_2501',
	'P_2502',
	'P_25384',
	'P_2680',
	'P_2683',
	'R_6074',
	'P_46989',
	'R_20472',
	'P_48539',
	'P_48540',
	'PRE_P1351OT',
	'PRE_P2683OT',
	'PRE_12107500',
	'PRE_12107BOLUS',
	'PRE_12108250',
	'PRE_12108BOL',
	'PRE_268075',
	'PRE_P12105',
	'PRE_P2368',
	'PRE_P2393OT',
	'PREIV_12NS001',
	'PREIV_12NS002',
	'PREIV_12NS003',
	'PREIV_12NS004',
	'PREIV_12NS005',
	'PREIV_12NS006',
	'PREIV_12NS007',
	'PREIV_12NSCKL008',
	'PREIV_12NSCKL009',
	'PREIV_12NSCKL010',
	'PREIV_12NSCKL011',
	'PREIV_12NSCKL012',
	'PREIV_12NSCKL013',
	'PREIV_12NSCKL014',
	'PREIV_14NS001',
	'PREIV_14NS002',
	'PREIV_14NS003',
	'PREIV_14NS004',
	'PREIV_14NS005',
	'PREIV_14NS006',
	'PREIV_14NS007',
	'PREIV_LRK033',
	'PREIV_NSKCL008',
	'PREIV_NSKCL009',
	'PREIV_NSKCL010',
	'PREIV_NSKCL011',
	'PREIV_NSKCL012',
	'PREIV_NSKCL013',
	'PREIV_NSKCL014',
	'PREIV_NSKCL022',
	'PREIV_NSKCL024',
	'PREIV_NSKCL025',
	'PREIV_NSKCL026',
	'PREIV_NSKCL027',
	'PREIV_NSKCL028',
	'PRE_17290NS',
	'PRE_17290NSD',
	'PRE_17290NSE',
	'PRE_17290NSF',
	'PRE_17290NSA',
	'PRE_17290NSB',
	'PRE_17290NSC',
	'PRE_2680IV1',
	'PRE_12107IV2',
	'PRE_12108X6HRS',
	'PRE_568701',
	'PRE_20653IV01',
	'P_12078',
	'R_32881',
	'P_12079',
	'P_12081',
	'P_12082',
	'P_12085',
	'P_12088',
	'R_76598',
	'P_12089',
	'P_12092',
	'R_76600',
	'P_12093',
	'P_12095',
	'R_8581',
	'P_12096',
	'R_2296',
	'P_12097',
	'P_12098',
	'R_32882',
	'P_12099',
	'P_2369',
	'P_2497',
	'P_2498',
	'P_2499',
	'P_2500',
	'P_2662',
	'P_33620',
	'R_32886',
	'P_43291',
	'P_48541',
	'P_48542',
	'PRE_2662PO',
	'PRE_2662PO1',
	'PRE_26881125H',
	'PRE_33620IV1',
	'PRE_33620IV2',
	'PRE_33620IV3',
	'PRE_33620IV4',
	'PRE_33620IV5',
	'Dextrose 10% In',
	'PRE_12099IVCD'
	)
-- THE FOLLOWING GETS RID OF ORDERS THAT WERE DISCONTINUED
-- ONLY FOR EKG, CHEST XRAY PORTABLE, LACTIC ACID, CBC W/DIFF
AND SO.ord_no NOT IN (
	SELECT SO.ord_no
	
	FROM smsdss.BMH_PLM_PtAcct_Clasf_Dx_V PDV
	JOIN smsdss.BMH_PLM_PtAcct_V PV
	ON PDV.PtNo_Num = PV.PtNo_Num
	JOIN smsdss.dx_cd_dim_v DX
	ON PV.prin_dx_cd = DX.dx_cd
	JOIN smsmir.sr_ord SO
	ON PV.PtNo_Num = SO.episode_no
	JOIN smsmir.sr_ord_sts_hist SOS
	ON SO.ord_no = SOS.ord_no
	JOIN smsmir.ord_sts_modf_mstr OSM
	ON SOS.hist_sts = OSM.ord_sts_modf_cd
	
	WHERE OSM.ord_sts IN (
		'DISCONTINUE'
		,'CANCEL'
		)
	AND PDV.ClasfCd IN (
		'785.52', '995.91', '995.92', '995.93', '995.94', '999.39', '999.89'
		)
	AND PV.hosp_svc NOT IN (
		'DIA'
		,'DMS'
		,'EME'
		)
	AND SO.svc_cd IN (
		'00407304',
		'00507301',
		--'00600015', -- <-- ekg
		'00402347'
		)
)
ORDER BY PV.PtNo_Num, SO.ord_no, SOS.prcs_dtime