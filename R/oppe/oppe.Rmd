---
title: "OPPE Report"
author: "Steven P. Sanderson II, MPH - Data Scientist/IT Manager"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    highlight: tango
    theme: flatly
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Lib Load ----
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
    "tidyverse"
    , "tidyquant"
    , "lubridate"
    , "R.utils"
    , "tibbletime"
    , "knitr"
    , "kableExtra"
    , "anomalize"
    , "DBI"
    , "odbc"
    , "dbplyr"
    , "readxl"
)

# Source Functions ----
my_path <- ("S:\\Global Finance\\1 REVENUE CYCLE\\Steve Sanderson II\\Code\\R\\Functions\\")
source_files <- list.files(my_path, "*.R")
load_files <-  subset(
    source_files
    , subset = (
        str_detect(source_files, "oppe_") | 
            str_detect(source_files, "clean")
    )
)
map(paste0(my_path, load_files), source)

# DB Connection ----
# db_con <- dbConnect(
#     odbc(),
#     Driver = "SQL Server",
#     Server = "BMH-HIDB",
#     Database = "SMSPHDSSS0X0",
#     Trusted_Connection = T
# )

# Report Parameters ----
# Dates
alos_start_date <- Sys.Date() %m-% months(18) %>%
    floor_date(unit = "months")
alos_end_date <- Sys.Date() %>%
    floor_date(unit = "months")

# Provider
provider_id = '017863'

# Tables ----
# Provider tbl ----
provider_tbl <- oppe_provider_tbl(provider_id = provider_id)

# ALOS Tables ----
alos_svc_line_tbl <- oppe_alos_svc_line_tbl()
alos_pav_tbl      <- oppe_alos_pav_tbl(provider_id = provider_id)
alos_bench_tbl    <- oppe_alos_bench_tbl()
alos_pyr_dim_tbl  <- oppe_alos_pyr_dim_tbl()
alos_aprdrg_tbl   <- oppe_alos_aprdrg_tbl()
alos_outlier_tbl  <- oppe_alos_outlier_tbl()
alos_vst_rpt_tbl  <- oppe_alos_vst_rpt_tbl()
alos_tbl          <- oppe_alos_final_tbl()

# Readmit Tables ----
ra_detail_tbl <- oppe_ra_detail_tbl()
ra_bench_tbl  <- oppe_ra_bench_tbl()
ra_vst_tbl    <- oppe_ra_vst_tbl()
readmit_tbl   <- oppe_ra_final_tbl()

# CPOE Tables ----
cpoe_detail_tbl <- oppe_cpoe_detail_tbl(provider_id = provider_id)
cpoe_tbl        <- oppe_cpoe_tbl()

# Denials Tables ----
denials_tbl <- oppe_denials_detail_tbl(provider_id = provider_id)

# Final Denials Table
denials_tbl <- denials_tbl %>%
    clean_names() %>%
    mutate(
        adm_date = adm_date %>% ymd()
        , dsch_date = dsch_date %>% ymd()
    ) %>%
    as_tbl_time(index = adm_date) %>%
    arrange(adm_date) %>%
    distinct(pt_no_num, .keep_all = TRUE)

# Disconnect DB ----
#dbDisconnect(db_con)

# DRG Exclude ----
drg_exclude <- read_xlsx("G:\\R Studio Projects\\Credentialing_CPOE\\drg_exclude.xlsx") %>%
    clean_names()
# APR DRG Thresholds ----
apr_drg_thresholds_tbl <- read_xlsx("G:\\R Studio Projects\\Credentialing_CPOE\\apr_drg_thresholds.xlsx") %>%
    clean_names()
# APR DRG Exclude ----
apr_drg_exclude <- read_xlsx("G:\\R Studio Projects\\Credentialing_CPOE\\ra_apr_drg_exclude.xlsx") %>%
    clean_names()
```

# Information About Report

This report gives information on a providers performance in regards to a few things. The items this report covers are:

* Average Lengh of Stay
    + History with Linear Trend
    + Z-Score with Linear Trend
    + CMI and SOI with Linear Trend
    + Excess days from Benchmark
    + Excess Days Anomaly Analysis
    + Outliers are excluded, see [Appendix]
* Readmissions
    + History with Linear Trend
    + Z-Score with Linear Trend
    + CMI and SOI with Linear Trend
    + Excess Rate from Benchmark
    + Excess Readmit Rate Anomaly Analysis
    
Important note about ALOS Data:

* The inpatient account must have positive total charges on it
* The following Medical Staff Departments are excluded:
    + Anesthesiology
    + Emergency Department
    + Pathology

The following MS-DRG numbers are excluded:

```{r drg_exclude_tbl, echo=FALSE}
drg_exclude  %>%
    kable() %>%
    kable_styling(bootstrap_options = c(
        "striped"
        , "hover"
        , "condensed"
        , "responsive"
        )
        , font_size = 12
        , full_width = F
    )
```

Import note about Readmit Data:

* Only discharge dispositions of AHR and ATW (Home & Home - Adult Home - Assisted Living) are included
* Certain APR-DRG's are excluded, see [Appendix]

# Data Exploration

#### Discharges and ALOS data
```{r discharges_and_alos_by_provider, echo=FALSE}
alos_tbl %>%
    select(
        proper_name
        , los
        , performance
        ) %>%
    group_by(proper_name) %>%
    summarize(
        Total_Discharges = n()
        , ALOS = round(mean(los), 2)
        , ELOS = round(mean(performance), 2)
        , Excess = (ALOS - ELOS)
    ) %>%
    ungroup() %>%
    set_names(
        c(
            "Provider"
            , "Total Discharges"
            , "ALOS"
            , "ELOS"
            , "Excess"
        )
    )  %>%
    kable() %>%
    kable_styling(bootstrap_options = c(
        "striped"
        , "hover"
        , "condensed"
        , "responsive"
        )
        , font_size = 12
        , full_width = F
        , position = "left"
    ) 
```

#### Discharges and Readmit Rate data
```{r discharges_and_readmit_rate_by_provider, echo=FALSE}
readmit_tbl %>%
    select(
        proper_name
        , pt_count
        , readmit_count
        , readmit_rate_bench
        , interim
        , los
    ) %>%
    group_by(proper_name) %>%
    summarize(
        Total_Discharges = sum(pt_count)
        , rr = round((sum(readmit_count) / Total_Discharges), 4)
        , perf = round(mean(readmit_rate_bench), 4)
        , Excess = (rr - perf)
        , interim = round(mean(interim, na.rm = T), 2)
        , alos = round(mean(los), 2)
        , rr_text = scales::percent(rr)
        , perf_text = scales::percent(perf)
        , excess_text = scales::percent(Excess)
    ) %>%
    ungroup() %>%
    set_names(
        c(
            "Provider"
            , "Total Discharges"
            , "Readmit Rate"
            , "Expected Rate"
            , "Excess Readmit Rate"
            , "Mean Days to Readmit"
            , "ALOS"
            , "Readmit Rate %"
            , "Expected Rate %"
            , "Excess Rate %"
        )
    ) %>%
    select(
        Provider
        , "Total Discharges"
        , "Readmit Rate %"
        , "Expected Rate %"
        , "Excess Rate %"
        , "ALOS"
        , "Mean Days to Readmit"
    ) %>%
    kable() %>%
    kable_styling(bootstrap_options = c(
        "striped"
        , "hover"
        , "condensed"
        , "responsive"
        )
        , font_size = 12
        , full_width = F
        , position = "left"
    )
```
#### Denial Data

Denial data is gathered by a patients admit date. The data is gathered from today minus 5 years, starting on the first of the year. For example if today is 2019-11-05 then the start date is 2014-01-01.

```{r denial_tbl, echo = FALSE}
denials_tbl %>%
    select(
        pt_no_num
        , adm_date
        , days_stay
        , denial_flag
        , um_days_denied
        , dollars_appealed
        , dollars_recovered
        , tot_chg_amt
        , plm_pt_acct_type
    ) %>%
    group_by(plm_pt_acct_type) %>%
    summarize(
        tot_admits = n()
        , tot_denials = sum(denial_flag)
        , alos = round(mean(days_stay), 2)
        , avg_denied_days = case_when(
          is.nan(round(mean(um_days_denied, na.rm = T), 2))
          ~ 0
          , TRUE ~ round(mean(um_days_denied, na.rm = T), 2)
        )
        , tot_dollars_denied = sum(dollars_appealed, na.rm = T)
        , tot_dollars_recoverd = sum(dollars_recovered, na.rm = T)
        , tot_chgs = sum(tot_chg_amt)
        , denial_pct = (tot_denials / tot_admits)
        , denial_dollar_pct = (
            sum(dollars_appealed, na.rm = T) / sum(tot_chg_amt, na.rm = T)
        )
        , recovery_pct = case_when(
          is.nan(tot_dollars_recoverd / tot_dollars_denied) ~ 0
          , TRUE ~ (tot_dollars_recoverd / tot_dollars_denied)
        ) #(tot_dollars_recoverd / tot_dollars_denied)
    ) %>%
    mutate(
        tot_dollars_denied = tot_dollars_denied %>% scales::dollar()
        , tot_dollars_recoverd = tot_dollars_recoverd %>% scales::dollar()
        , tot_chgs = tot_chgs %>% scales::dollar()
        , denial_pct = denial_pct %>% scales::percent()
        , denial_dollar_pct = denial_dollar_pct %>% scales::percent()
        , recovery_pct = recovery_pct %>% scales::percent()
    ) %>%
    ungroup() %>%
    set_names(
        "IP/OP"
        , "Admits"
        , "Denials"
        , "ALOS"
        , "Avg Days Denied"
        , "Dollars Denied"
        , "Dollars Recovered"
        , "Total Charges"
        , "% Cases Denied"
        , "% Dollars Denied"
        , "% Recovered"
    ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c(
            "striped"
            , "hover"
            , "condensed"
            , "responsive"
            )
        , font_size = 12
        , full_width = T
        , position = "left"
    ) 
```

# CPOE Order Plots

```{r oppe_plot, echo=FALSE, message=FALSE,warning=FALSE}
# Viz ----
oppe_cpoe_plot(cpoe_tbl)
```

# Length of Stay Trends

```{r alos_trend_tbl, echo=FALSE, message=FALSE, warning=FALSE}
oppe_alos_plot(alos_tbl)
```

# Readmission Trends

```{r readmit_trend_tbl, echo=FALSE, message=FALSE, warning=FALSE}
oppe_readmit_plot(readmit_tbl)
```

# Gartner Magic Chart

Shows data collapsed by week. Excess Readmit Rate on the y axis and Excess LOS on the x axis. A provider wants to be in the lower left quadrant where both x and y are negative.

```{r gartner_magic_chart, echo=FALSE, message=FALSE, warning=FALSE}
oppe_gartner_magic_plot()
```

# Denials

```{r denials_plts, echo=FALSE, message=FALSE, warning=FALSE}
oppe_denials_plot()
```

# Appendix

#### APR-DRG thresholds

<details>
<summary>Click to see APR-DRG Thresholds</summary>
```{r apr_drg_thresholds, echo=FALSE, message=FALSE, warning=FALSE}
apr_drg_thresholds_tbl %>%
  set_names("APR DRG","Description","Threshold") %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```
</details>
</p>

<details>
<summary>Click to see APR-DRG Exclusions for Readmits</summary>
```{r apr_drg_exclude, echo=FALSE, message=FALSE, warning=FALSE}
apr_drg_exclude %>%
    set_names("APR DRG","Description") %>%
    kable() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```
</details>

```{r clear_env, echo=FALSE, message=FALSE, warning=FALSE}
rm(list = ls())
```