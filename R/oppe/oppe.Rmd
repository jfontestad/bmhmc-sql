---
title: "OPPE Report"
author: "Steven P. Sanderson II, MPH - Data Scientist/IT Manager"
date: "2019-11-04"
output:
  html_document:
    code_folding: show
    highlight: tango
    theme: flatly
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Lib Load ----
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
    "tidyverse"
    , "tidyquant"
    , "readxl"
    , "R.utils"
    , "tibbletime"
    , "knitr"
    , "kableExtra"
    , "anomalize"
)

# Source Functions ----
source("S:\\Global Finance\\1 REVENUE CYCLE\\Steve Sanderson II\\Code\\R\\Functions\\clean_names.R")
source("S:\\Global Finance\\1 REVENUE CYCLE\\Steve Sanderson II\\Code\\R\\Functions\\oppe_cpoe_plot.R")
source("S:\\Global Finance\\1 REVENUE CYCLE\\Steve Sanderson II\\Code\\R\\Functions\\oppe_readmit_plot.R")
source("S:\\Global Finance\\1 REVENUE CYCLE\\Steve Sanderson II\\Code\\R\\Functions\\oppe_alos_plot.R")
source("S:\\Global Finance\\1 REVENUE CYCLE\\Steve Sanderson II\\Code\\R\\Functions\\oppe_gartner_magic_plot.R")
source("S:\\Global Finance\\1 REVENUE CYCLE\\Steve Sanderson II\\Code\\R\\Functions\\oppe_denials_plot.R")

# Data load ----
df_time_tbl <- read_xlsx("cpoe.xlsx", sheet = "DATA") %>%
    clean_names() %>%
    mutate(ent_date = lubridate::as_date(ent_date)) %>%
    as_tbl_time(index = ent_date) %>%
    arrange(ent_date)

drg_exclude <- read_xlsx("drg_exclude.xlsx") %>%
    clean_names()

apr_drg_thresholds_tbl <- read_xlsx("apr_drg_thresholds.xlsx") %>%
    clean_names()

alos_tbl <- read_xlsx("alos_data.xlsx") %>%
    clean_names() %>%
    as_tbl_time(alos_tbl, index = dsch_date)

readmit_tbl <- read_xlsx("readmit_data.xlsx") %>%
    clean_names() %>%
    as_tbl_time(readmit_tbl, index = dsch_date)

apr_drg_exclude <- read_xlsx("ra_apr_drg_exclude.xlsx") %>%
    clean_names()

denials_tbl <- read_xlsx("denials_data.xlsx", sheet = "data") %>%
    clean_names() %>%
    as_tbl_time(index = adm_date)
```

# Information About Report

This report gives information on a providers performance in regards to a few things. The items this report covers are:

* Average Lengh of Stay
    + History with Linear Trend
    + Z-Score with Linear Trend
    + CMI and SOI with Linear Trend
    + Excess days from Benchmark
    + Excess Days Anomaly Analysis
    + Outliers are excluded, see [Appendix]
* Readmissions
    + History with Linear Trend
    + Z-Score with Linear Trend
    + CMI and SOI with Linear Trend
    + Excess Rate from Benchmark
    + Excess Readmit Rate Anomaly Analysis
    
Important note about ALOS Data:

* The inpatient account must have positive total charges on it
* The following Medical Staff Departments are excluded:
    + Anesthesiology
    + Emergency Department
    + Pathology

The following MS-DRG numbers are excluded:

```{r drg_exclude_tbl, echo=FALSE}
drg_exclude  %>%
    kable() %>%
    kable_styling(bootstrap_options = c(
        "striped"
        , "hover"
        , "condensed"
        , "responsive"
        )
        , font_size = 12
        , full_width = F
    )
```

Import note about Readmit Data:

* Only discharge dispositions of AHR and ATW (Home & Home - Adult Home - Assisted Living) are included
* Certain APR-DRG's are excluded, see [Appendix]

# Data Exploration

#### Discharges and ALOS data
```{r discharges_and_alos_by_provider, echo=FALSE}
alos_tbl %>%
    select(
        proper_name
        , los
        , performance
        ) %>%
    group_by(proper_name) %>%
    summarize(
        Total_Discharges = n()
        , ALOS = round(mean(los), 2)
        , ELOS = round(mean(performance), 2)
        , Excess = (ALOS - ELOS)
    ) %>%
    ungroup() %>%
    set_names(
        c(
            "Provider"
            , "Total Discharges"
            , "ALOS"
            , "ELOS"
            , "Excess"
        )
    )  %>%
    kable() %>%
    kable_styling(bootstrap_options = c(
        "striped"
        , "hover"
        , "condensed"
        , "responsive"
        )
        , font_size = 12
        , full_width = F
        , position = "left"
    ) 
```

#### Discharges and Readmit Rate data
```{r discharges_and_readmit_rate_by_provider, echo=FALSE}
readmit_tbl %>%
    select(
        proper_name
        , pt_count
        , readmit_count
        , readmit_rate_bench
        , interim
        , los
    ) %>%
    group_by(proper_name) %>%
    summarize(
        Total_Discharges = sum(pt_count)
        , rr = round((sum(readmit_count) / Total_Discharges), 4)
        , perf = round(mean(readmit_rate_bench), 4)
        , Excess = (rr - perf)
        , interim = round(mean(interim, na.rm = T), 2)
        , alos = round(mean(los), 2)
        , rr_text = scales::percent(rr)
        , perf_text = scales::percent(perf)
        , excess_text = scales::percent(Excess)
    ) %>%
    ungroup() %>%
    set_names(
        c(
            "Provider"
            , "Total Discharges"
            , "Readmit Rate"
            , "Expected Rate"
            , "Excess Readmit Rate"
            , "Mean Days to Readmit"
            , "ALOS"
            , "Readmit Rate %"
            , "Expected Rate %"
            , "Excess Rate %"
        )
    ) %>%
    select(
        Provider
        , "Total Discharges"
        , "Readmit Rate %"
        , "Expected Rate %"
        , "Excess Rate %"
        , "ALOS"
        , "Mean Days to Readmit"
    ) %>%
    kable() %>%
    kable_styling(bootstrap_options = c(
        "striped"
        , "hover"
        , "condensed"
        , "responsive"
        )
        , font_size = 12
        , full_width = F
        , position = "left"
    )
```
#### Denial Data

Denial data is gathered by a patients admit date. The data is gathered from today minus 5 years, starting on the first of the year. For example if today is 2019-11-05 then the start date is 2014-01-01.

```{r denial_tbl, echo = FALSE}
denials_tbl %>%
    select(
        pt_no_num
        , adm_date
        , days_stay
        , denial_flag
        , um_days_denied
        , dollars_appealed
        , dollars_recovered
        , tot_chg_amt
        , plm_pt_acct_type
    ) %>%
    group_by(plm_pt_acct_type) %>%
    summarize(
        tot_admits = n()
        , tot_denials = sum(denial_flag)
        , alos = round(mean(days_stay), 2)
        , avg_denied_days = case_when(
          is.nan(round(mean(um_days_denied, na.rm = T), 2))
          ~ 0
          , TRUE ~ round(mean(um_days_denied, na.rm = T), 2)
        )
        , tot_dollars_denied = sum(dollars_appealed, na.rm = T)
        , tot_dollars_recoverd = sum(dollars_recovered, na.rm = T)
        , tot_chgs = sum(tot_chg_amt)
        , denial_pct = (tot_denials / tot_admits)
        , denial_dollar_pct = (
            sum(dollars_appealed, na.rm = T) / sum(tot_chg_amt, na.rm = T)
        )
        , recovery_pct = case_when(
          is.nan(tot_dollars_recoverd / tot_dollars_denied) ~ 0
          , TRUE ~ (tot_dollars_recoverd / tot_dollars_denied)
        ) #(tot_dollars_recoverd / tot_dollars_denied)
    ) %>%
    mutate(
        tot_dollars_denied = tot_dollars_denied %>% scales::dollar()
        , tot_dollars_recoverd = tot_dollars_recoverd %>% scales::dollar()
        , tot_chgs = tot_chgs %>% scales::dollar()
        , denial_pct = denial_pct %>% scales::percent()
        , denial_dollar_pct = denial_dollar_pct %>% scales::percent()
        , recovery_pct = recovery_pct %>% scales::percent()
    ) %>%
    ungroup() %>%
    set_names(
        "IP/OP"
        , "Admits"
        , "Denials"
        , "ALOS"
        , "Avg Days Denied"
        , "Dollars Denied"
        , "Dollars Recovered"
        , "Total Charges"
        , "% Cases Denied"
        , "% Dollars Denied"
        , "% Recovered"
    ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c(
            "striped"
            , "hover"
            , "condensed"
            , "responsive"
            )
        , font_size = 12
        , full_width = T
        , position = "left"
    ) 
```

# CPOE Order Plots

```{r oppe_plot, echo=FALSE}
# Viz ----
oppe_cpoe_plot(df_time_tbl)
```

# Length of Stay Trends

```{r alos_trend_tbl, echo=FALSE, message=FALSE}
oppe_alos_plot(alos_tbl)
```

# Readmission Trends

```{r readmit_trend_tbl, echo=FALSE, message=FALSE}
oppe_readmit_plot(readmit_tbl)
```

# Gartner Magic Chart

Shows data collapsed by week. Excess Readmit Rate on the y axis and Excess LOS on the x axis. A provider wants to be in the lower left quadrant where both x and y are negative.

```{r gartner_magic_chart, echo=FALSE}
oppe_gartner_magic_plot()
```

# Denials

```{r denials_plts, echo=FALSE, message=FALSE}
oppe_denials_plot()
```

# Appendix

#### APR-DRG thresholds

<details>
<summary>Click to see APR-DRG Thresholds</summary>
```{r apr_drg_thresholds, echo=FALSE}
apr_drg_thresholds_tbl %>%
  set_names("APR DRG","Description","Threshold") %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```
</details>
</p>

<details>
<summary>Click to see APR-DRG Exclusions for Readmits</summary>
```{r apr_drg_exclude, echo=FALSE}
apr_drg_exclude %>%
    set_names("APR DRG","Description") %>%
    kable() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```
</details>